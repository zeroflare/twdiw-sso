<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>TWDIW OIDC Client ç®¡ç†</title>

    <!-- Bulma -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css">

    <!-- DataTables -->
    <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/datatables.net-dt@2.3.4/css/dataTables.dataTables.min.css">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.3.4/js/dataTables.min.js"></script>

    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11.12.4/dist/sweetalert2.all.min.js"></script>

</head>

<body class="has-background-light" style="min-height:100vh; display:flex; flex-direction:column;">

    <nav class="navbar is-primary" role="navigation" aria-label="main navigation">
        <div class="container">
            <div class="navbar-brand">
                <a class="navbar-item has-text-white" href="/">
                    <strong>æ•¸ä½æ†‘è­‰çš®å¤¾ OIDC</strong>
                </a>

                <!-- æ¼¢å ¡æŒ‰éˆ• -->
                <a role="button" class="navbar-burger has-text-white" aria-label="menu" aria-expanded="false"
                    data-target="navbarMenu">
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                    <span aria-hidden="true"></span>
                </a>
            </div>

            <div id="navbarMenu" class="navbar-menu">
                <div class="navbar-start">
                    <a href="/dashboard" class="navbar-item has-text-white is-active">
                        ç®¡ç†å¾Œå°
                    </a>
                    <a href="/auth/register" class="navbar-item has-text-white">
                        è¨»å†Šé›»å­ä¿¡ç®±å¡
                    </a>
                    <a href="/cloudflareaccess" target="_blank" class="navbar-item has-text-white">
                        æ¸¬è©¦ç™»å…¥ Cloudflare Access
                    </a>
                </div>

                <div class="navbar-end">
                    <div class="navbar-item">
                        <a href="https://github.com/zeroflare/twdiw-oidc" target="_blank"
                            class="button is-light is-small mr-2">
                            <span class="icon">
                                <img src="https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/github.svg"
                                    alt="GitHub" width="20" height="20">
                            </span>
                            <span>GitHub</span>
                        </a>
                        <!-- ğŸ”¹ æ”¹ç‚º JS ç™»å‡º -->
                        <button id="logoutBtn" class="button is-light is-small">ç™»å‡º</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Navbar toggle -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const $navbarBurgers = Array.from(document.querySelectorAll('.navbar-burger'));
            $navbarBurgers.forEach(el => {
                el.addEventListener('click', () => {
                    const target = el.dataset.target;
                    const $target = document.getElementById(target);
                    el.classList.toggle('is-active');
                    $target.classList.toggle('is-active');
                });
            });

            // ğŸ”¹ ç™»å‡ºåŠŸèƒ½
            const logoutBtn = document.getElementById('logoutBtn');
            logoutBtn.addEventListener('click', async () => {
                try {
                    const res = await fetch('/api/auth/logout');
                    if (res.ok) {
                        Swal.fire({
                            title: 'å·²ç™»å‡º',
                            text: 'æ‚¨å·²æˆåŠŸç™»å‡ºã€‚',
                            icon: 'success',
                            confirmButtonText: 'è¿”å›é¦–é ',
                            confirmButtonColor: '#3273dc'
                        }).then(() => {
                            window.location.href = '/';
                        });
                    } else {
                        throw new Error('ç™»å‡ºå¤±æ•—');
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'éŒ¯èª¤',
                        text: error.message || 'ç™»å‡ºæ™‚ç™¼ç”Ÿå•é¡Œ',
                        icon: 'error',
                        confirmButtonText: 'ç¢ºå®š'
                    });
                }
            });
        });
    </script>

    <!-- Main Section -->
    <section class="section is-flex-grow-1">
        <div class="container">
            <div class="box">
                <h1 class="title is-3 mb-4 has-text-centered">OIDC Client ç®¡ç†</h1>

                <div class="content">
                    <p>æ–¼ä¸‹æ–¹å»ºç«‹ OIDC Clientï¼Œè¨­å®š Redirect URIsï¼Œä¸¦å–å¾— Client ID èˆ‡ Client Secretã€‚</p>
                    <ul>
                        <li>Auth URLï¼š<span class="tag baseurl is-medium">/auth/login</span></li>
                        <li>Token URLï¼š<span class="tag baseurl is-medium">/api/oidc/token</span></li>
                        <li>Certificate URLï¼š<span class="tag baseurl is-medium">/api/oidc/jwks</span></li>
                    </ul>
                </div>

                <div class="has-text-right mb-3">
                    <button id="addBtn" class="button is-primary is-medium has-text-white">æ–°å¢ Client</button>
                </div>

                <div class="table-container">
                    <table id="clientsTable" class="table is-striped is-fullwidth">
                        <thead>
                            <tr>
                                <th>Client Name</th>
                                <th>Client ID</th>
                                <th>Client Secret</th>
                                <th>Redirect URIs</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
        </div>
    </section>

    <!-- ä¸»è¦é‚è¼¯ -->
    <script>
        (async () => {
            try {
                // é©—è­‰ç™»å…¥ç‹€æ…‹
                const response = await fetch('/api/auth/me');
                if (!response.ok) throw new Error('Not authenticated');
                const user = await response.json();
                console.log('Logged in as:', user);

                // åªæœ‰æˆåŠŸé©—è­‰å¾Œï¼Œæ‰ç¹¼çºŒåŸ·è¡Œä»¥ä¸‹å…§å®¹
                const baseUrl = window.location.origin;
                document.querySelectorAll('.baseurl').forEach(el => {
                    el.textContent = baseUrl + el.textContent;
                });

                // åˆå§‹åŒ– DataTable
                const table = new DataTable('#clientsTable', {
                    ajax: { url: '/api/clients', dataSrc: '' },
                    columns: [
                        { data: 'name' },
                        { data: 'client_id' },
                        { data: 'client_secret' },
                        { data: 'redirect_uris' },
                        {
                            data: null,
                            render: (data, type, row) => `
            <div class="buttons are-small">
              <button class="doedit button is-light" data-id="${row.id}">ç·¨è¼¯</button>
              <button class="dodelete button is-light" data-id="${row.id}">åˆªé™¤</button>
            </div>
          `
                        }
                    ],
                    paging: false,
                    searching: false,
                    info: false,
                    ordering: false,
                    language: {
                        url: 'https://cdn.datatables.net/plug-ins/2.0.3/i18n/zh-HANT.json'
                    }
                });


                // æ–°å¢ Client
                document.getElementById('addBtn').addEventListener('click', async () => {
                    const { value: formValues } = await Swal.fire({
                        title: 'æ–°å¢ Client',
                        html: `
          <div style="text-align:left;">
            <div class="field">
              <label class="label">Client Name</label>
              <div class="control">
                <input id="swal-name" class="input" type="text" placeholder="myapp" required>
              </div>
            </div>
            <div class="field">
              <label class="label">Redirect URIsï¼ˆä»¥æ›è¡Œåˆ†éš”ï¼‰</label>
              <div class="control">
                <textarea id="swal-redirect_uris" class="textarea" placeholder="https://example.com/callback
https://example.org/redirect" required></textarea>
              </div>
            </div>
          </div>`,
                        focusConfirm: false,
                        showCloseButton: true,
                        confirmButtonText: 'æ–°å¢',
                        preConfirm: () => ({
                            name: document.getElementById('swal-name').value.trim(),
                            redirect_uris: document.getElementById('swal-redirect_uris').value.trim()
                        })
                    });

                    if (formValues) {
                        const res = await fetch('/api/clients', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(formValues)
                        });
                        if (res.ok) {
                            Swal.fire('æˆåŠŸ', 'Client å·²æ–°å¢', 'success');
                            table.ajax.reload();
                        } else {
                            Swal.fire('éŒ¯èª¤', 'æ–°å¢å¤±æ•—', 'error');
                        }
                    }
                });

                // ç·¨è¼¯èˆ‡åˆªé™¤äº‹ä»¶
                document.querySelector('#clientsTable tbody').addEventListener('click', async (e) => {
                    const id = e.target.dataset.id;
                    if (!id) return;

                    // ç·¨è¼¯
                    if (e.target.classList.contains('doedit')) {
                        const res = await fetch(`/api/clients/${id}`);
                        const client = await res.json();

                        const { value: formValues } = await Swal.fire({
                            title: 'ç·¨è¼¯ Client',
                            html: `
            <div style="text-align:left;">
              <div class="field">
                <label class="label">Client Name</label>
                <div class="control">
                  <input id="swal-name" class="input" type="text" value="${client.name || ''}" required>
                </div>
              </div>
              <div class="field">
                <label class="label">Redirect URIsï¼ˆä»¥æ›è¡Œåˆ†éš”ï¼‰</label>
                <div class="control">
                  <textarea id="swal-redirect_uris" class="textarea" required>${client.redirect_uris || ''}</textarea>
                </div>
              </div>
            </div>`,
                            focusConfirm: false,
                            confirmButtonText: 'æ›´æ–°',
                            preConfirm: () => ({
                                name: document.getElementById('swal-name').value.trim(),
                                redirect_uris: document.getElementById('swal-redirect_uris').value.trim()
                            })
                        });

                        if (formValues) {
                            const update = await fetch(`/api/clients/${id}`, {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(formValues)
                            });
                            if (update.ok) {
                                Swal.fire('æˆåŠŸ', 'Client å·²æ›´æ–°', 'success');
                                table.ajax.reload();
                            } else {
                                Swal.fire('éŒ¯èª¤', 'æ›´æ–°å¤±æ•—', 'error');
                            }
                        }
                    }

                    // åˆªé™¤
                    if (e.target.classList.contains('dodelete')) {
                        const confirm = await Swal.fire({
                            title: 'ç¢ºèªåˆªé™¤ï¼Ÿ',
                            text: 'æ­¤æ“ä½œç„¡æ³•å¾©åŸ',
                            icon: 'warning',
                            showCancelButton: true,
                            confirmButtonText: 'åˆªé™¤',
                            cancelButtonText: 'å–æ¶ˆ'
                        });
                        if (confirm.isConfirmed) {
                            const res = await fetch(`/api/clients/${id}`, { method: 'DELETE' });
                            if (res.ok) {
                                Swal.fire('å·²åˆªé™¤', '', 'success');
                                table.ajax.reload();
                            } else {
                                Swal.fire('éŒ¯èª¤', 'åˆªé™¤å¤±æ•—', 'error');
                            }
                        }
                    }
                });

            } catch (error) {
                // é©—è­‰å¤±æ•— â†’ è·³è½‰ç™»å…¥é 
                console.error('Authentication check failed, redirecting to /');
                window.location.href = '/auth/login?redirect_uri=/dashboard';
            }
        })();


    </script>

</body>

</html>